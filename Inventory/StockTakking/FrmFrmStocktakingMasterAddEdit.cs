using Bll.Inventory.StockTakking;
using Bll.MasterData.CompanyBll;
using Common.Utils;
using DevExpress.XtraBars;
using DevExpress.XtraEditors;
using DTO.Inventory.StockTakking;
using Logger;
using Logger.Configuration;
using Logger.Interfaces;
using System;
using System.Threading.Tasks;

namespace Inventory.StockTakking
{
    public partial class FrmFrmStocktakingMasterAddEdit : XtraForm
    {
        #region ========== FIELDS & PROPERTIES ==========

        /// <summary>
        /// ID c·ªßa StocktakingMaster (d√πng khi edit)
        /// Guid.Empty n·∫øu l√† th√™m m·ªõi
        /// </summary>
        private readonly Guid _stocktakingMasterId;

        /// <summary>
        /// Business Logic Layer cho StocktakingMaster
        /// </summary>
        private readonly StocktakingMasterBll _stocktakingMasterBll = new StocktakingMasterBll();

        /// <summary>
        /// Business Logic Layer cho CompanyBranch (d√πng cho Warehouse lookup)
        /// </summary>
        private readonly CompanyBranchBll _companyBranchBll = new CompanyBranchBll();

        /// <summary>
        /// Logger ƒë·ªÉ ghi log
        /// </summary>
        private readonly ILogger _logger;

        /// <summary>
        /// Flag ƒë·ªÉ ki·ªÉm tra xem s·ªë phi·∫øu ƒë√£ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông ch∆∞a
        /// </summary>
        private bool _isVoucherNumberAutoGenerated;

        /// <summary>
        /// Gi√° tr·ªã s·ªë phi·∫øu t·ª± ƒë·ªông t·∫°o cu·ªëi c√πng (ƒë·ªÉ so s√°nh khi ng∆∞·ªùi d√πng ch·ªânh s·ª≠a)
        /// </summary>
        private string _lastAutoGeneratedVoucherNumber = string.Empty;

        /// <summary>
        /// Flag ƒë·ªÉ b·ªè qua event EditValueChanged khi ƒëang set gi√° tr·ªã t·ª± ƒë·ªông
        /// </summary>
        private bool _isSettingAutoValue;

        #endregion

        #region ========== CONSTRUCTOR ==========

        /// <summary>
        /// Constructor v·ªõi tham s·ªë ID
        /// </summary>
        /// <param name="stocktakingMasterId">ID c·ªßa StocktakingMaster. Guid.Empty n·∫øu l√† th√™m m·ªõi</param>
        public FrmFrmStocktakingMasterAddEdit(Guid stocktakingMasterId)
        {
            _stocktakingMasterId = stocktakingMasterId;
            _logger = LoggerFactory.CreateLogger(LogCategory.UI);
            InitializeComponent();
            InitializeForm();
        }

        #endregion

        #region ========== INITIALIZATION & SETUP ==========

        /// <summary>
        /// Kh·ªüi t·∫°o form
        /// </summary>
        private void InitializeForm()
        {
            try
            {
                // Thi·∫øt l·∫≠p Text c·ªßa form theo ng·ªØ c·∫£nh
                SetFormTitle();

                // Load enum v√†o ComboBoxEdit (ph·∫£i load tr∆∞·ªõc khi load d·ªØ li·ªáu)
                LoadStocktakingTypeComboBox();
                LoadStocktakingStatusComboBox();

                // X·ª≠ l√Ω theo ch·∫ø ƒë·ªô (th√™m m·ªõi ho·∫∑c ƒëi·ªÅu ch·ªânh)
                if (_stocktakingMasterId == Guid.Empty)
                {
                    // Ch·∫ø ƒë·ªô th√™m m·ªõi
                    InitializeForAddMode();
                    
                    // Load datasource cho Warehouse (CompanyBranch) - c√≥ th·ªÉ load async
                    _ = LoadWarehouseDataSourceAsync();
                }
                else
                {
                    // Ch·∫ø ƒë·ªô ƒëi·ªÅu ch·ªânh - LoadExistingData s·∫Ω t·ª± load datasource
                    InitializeForEditMode();
                }

                // ƒêƒÉng k√Ω event khi thay ƒë·ªïi ng√†y ki·ªÉm kho ƒë·ªÉ t·ª± ƒë·ªông t·∫°o l·∫°i s·ªë phi·∫øu (ch·ªâ khi th√™m m·ªõi)
                StocktakingDateDateEdit.EditValueChanged += StocktakingDateDateEdit_EditValueChanged;
                
                // ƒêƒÉng k√Ω event khi ng∆∞·ªùi d√πng ch·ªânh s·ª≠a s·ªë phi·∫øu th·ªß c√¥ng
                VoucherNumberTextEdit.EditValueChanged += VoucherNumberTextEdit_EditValueChanged;

                // ƒêƒÉng k√Ω event Popup cho WarehouseNameSearchLookupEdit ƒë·ªÉ load l·∫°i d·ªØ li·ªáu khi m·ªü popup
                WarehouseNameSearchLookupEdit.Popup += WarehouseNameSearchLookupEdit_Popup;

                // ƒêƒÉng k√Ω event handlers cho bar buttons
                SaveBarButtonItem.ItemClick += SaveBarButtonItem_ItemClick;
                CloseBarButtonItem.ItemClick += CloseBarButtonItem_ItemClick;

                // Setup SuperToolTips
                SetupSuperToolTips();
            }
            catch (Exception ex)
            {
                _logger.Error($"InitializeForm: L·ªói kh·ªüi t·∫°o form: {ex.Message}", ex);
                ShowError(ex, "L·ªói kh·ªüi t·∫°o form");
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p Text c·ªßa form theo ng·ªØ c·∫£nh (th√™m m·ªõi ho·∫∑c ƒëi·ªÅu ch·ªânh)
        /// </summary>
        private void SetFormTitle()
        {
            if (_stocktakingMasterId == Guid.Empty)
            {
                // Ch·∫ø ƒë·ªô th√™m m·ªõi
                Text = @"Th√™m m·ªõi phi·∫øu ki·ªÉm kho";
            }
            else
            {
                // Ch·∫ø ƒë·ªô ƒëi·ªÅu ch·ªânh
                Text = @"ƒêi·ªÅu ch·ªânh phi·∫øu ki·ªÉm kho";
            }
        }

        /// <summary>
        /// Kh·ªüi t·∫°o form cho ch·∫ø ƒë·ªô th√™m m·ªõi
        /// </summary>
        private void InitializeForAddMode()
        {
            try
            {
                _logger.Debug("InitializeForAddMode: Kh·ªüi t·∫°o form cho ch·∫ø ƒë·ªô th√™m m·ªõi");

                // Thi·∫øt l·∫≠p ng√†y ki·ªÉm kho m·∫∑c ƒë·ªãnh l√† ng√†y hi·ªán t·∫°i
                StocktakingDateDateEdit.DateTime = DateTime.Now;
                
                // T·ª± ƒë·ªông t·∫°o s·ªë phi·∫øu khi th√™m m·ªõi
                GenerateVoucherNumber();

                // Set m·∫∑c ƒë·ªãnh cho c√°c tr∆∞·ªùng kh√°c
                // M·∫∑c ƒë·ªãnh: Lo·∫°i ki·ªÉm kho = Ki·ªÉm kho ƒë·ªãnh k·ª≥, Tr·∫°ng th√°i = Nh√°p
                SetStocktakingType(StocktakingTypeEnum.Periodic);
                SetStocktakingStatus(StocktakingStatusEnum.Draft);
            }
            catch (Exception ex)
            {
                _logger.Error($"InitializeForAddMode: L·ªói kh·ªüi t·∫°o ch·∫ø ƒë·ªô th√™m m·ªõi: {ex.Message}", ex);
                throw;
            }
        }

        /// <summary>
        /// Kh·ªüi t·∫°o form cho ch·∫ø ƒë·ªô ƒëi·ªÅu ch·ªânh
        /// </summary>
        private void InitializeForEditMode()
        {
            try
            {
                _logger.Debug($"InitializeForEditMode: Kh·ªüi t·∫°o form cho ch·∫ø ƒë·ªô ƒëi·ªÅu ch·ªânh, Id={_stocktakingMasterId}");

                // Load d·ªØ li·ªáu t·ª´ database
                LoadExistingData();
            }
            catch (Exception ex)
            {
                _logger.Error($"InitializeForEditMode: L·ªói kh·ªüi t·∫°o ch·∫ø ƒë·ªô ƒëi·ªÅu ch·ªânh: {ex.Message}", ex);
                throw;
            }
        }

        /// <summary>
        /// X·ª≠ l√Ω khi thay ƒë·ªïi ng√†y ki·ªÉm kho
        /// T·ª± ƒë·ªông t·∫°o l·∫°i s·ªë phi·∫øu n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô th√™m m·ªõi v√† s·ªë phi·∫øu ch∆∞a ƒë∆∞·ª£c ch·ªânh s·ª≠a th·ªß c√¥ng
        /// </summary>
        private void StocktakingDateDateEdit_EditValueChanged(object sender, EventArgs e)
        {
            try
            {
                // Ch·ªâ t·ª± ƒë·ªông t·∫°o l·∫°i s·ªë phi·∫øu n·∫øu:
                // 1. ƒêang ·ªü ch·∫ø ƒë·ªô th√™m m·ªõi
                // 2. S·ªë phi·∫øu ƒë√£ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông tr∆∞·ªõc ƒë√≥ (ch∆∞a ƒë∆∞·ª£c ch·ªânh s·ª≠a th·ªß c√¥ng)
                if (_stocktakingMasterId == Guid.Empty && _isVoucherNumberAutoGenerated)
                {
                    GenerateVoucherNumber();
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"StocktakingDateDateEdit_EditValueChanged: L·ªói t·∫°o s·ªë phi·∫øu: {ex.Message}", ex);
                ShowError(ex, "L·ªói t·∫°o s·ªë phi·∫øu");
            }
        }

        /// <summary>
        /// X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªânh s·ª≠a s·ªë phi·∫øu th·ªß c√¥ng
        /// Reset flag ƒë·ªÉ kh√¥ng t·ª± ƒë·ªông t·∫°o l·∫°i khi thay ƒë·ªïi ng√†y
        /// </summary>
        private void VoucherNumberTextEdit_EditValueChanged(object sender, EventArgs e)
        {
            // B·ªè qua event n·∫øu ƒëang set gi√° tr·ªã t·ª± ƒë·ªông
            if (_isSettingAutoValue)
                return;

            // N·∫øu ng∆∞·ªùi d√πng ch·ªânh s·ª≠a s·ªë phi·∫øu th·ªß c√¥ng, ƒë√°nh d·∫•u l√† kh√¥ng c√≤n t·ª± ƒë·ªông t·∫°o n·ªØa
            // Ch·ªâ reset n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô th√™m m·ªõi
            if (_stocktakingMasterId == Guid.Empty)
            {
                var currentVoucherNumber = VoucherNumberTextEdit.Text?.Trim();
                
                // N·∫øu gi√° tr·ªã hi·ªán t·∫°i kh√°c v·ªõi gi√° tr·ªã t·ª± ƒë·ªông t·∫°o cu·ªëi c√πng
                // => Ng∆∞·ªùi d√πng ƒë√£ ch·ªânh s·ª≠a th·ªß c√¥ng
                if (!string.IsNullOrEmpty(currentVoucherNumber) && 
                    currentVoucherNumber != _lastAutoGeneratedVoucherNumber)
                {
                    _isVoucherNumberAutoGenerated = false;
                }
            }
        }

        /// <summary>
        /// T·ª± ƒë·ªông t·∫°o s·ªë phi·∫øu ki·ªÉm kho
        /// </summary>
        private void GenerateVoucherNumber()
        {
            try
            {
                // Ch·ªâ t·∫°o s·ªë phi·∫øu khi ƒëang th√™m m·ªõi
                if (_stocktakingMasterId != Guid.Empty)
                    return;

                // L·∫•y ng√†y ki·ªÉm kho, n·∫øu ch∆∞a c√≥ th√¨ d√πng ng√†y hi·ªán t·∫°i
                var stocktakingDate = StocktakingDateDateEdit.DateTime;
                if (stocktakingDate == DateTime.MinValue)
                {
                    stocktakingDate = DateTime.Now;
                    StocktakingDateDateEdit.DateTime = stocktakingDate;
                }

                // G·ªçi BLL ƒë·ªÉ t·∫°o s·ªë phi·∫øu
                var voucherNumber = _stocktakingMasterBll.GenerateVoucherNumber(stocktakingDate);
                
                // Set flag ƒë·ªÉ b·ªè qua event EditValueChanged
                _isSettingAutoValue = true;
                try
                {
                    // G√°n s·ªë phi·∫øu v√†o TextEdit
                    VoucherNumberTextEdit.Text = voucherNumber;
                    
                    // L∆∞u gi√° tr·ªã t·ª± ƒë·ªông t·∫°o ƒë·ªÉ so s√°nh sau n√†y
                    _lastAutoGeneratedVoucherNumber = voucherNumber;
                    
                    // ƒê√°nh d·∫•u ƒë√£ t·∫°o t·ª± ƒë·ªông
                    _isVoucherNumberAutoGenerated = true;
                }
                finally
                {
                    // Reset flag
                    _isSettingAutoValue = false;
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"GenerateVoucherNumber: L·ªói t·∫°o s·ªë phi·∫øu t·ª± ƒë·ªông: {ex.Message}", ex);
                ShowError(ex, "L·ªói t·∫°o s·ªë phi·∫øu t·ª± ƒë·ªông");
            }
        }

        #endregion

        #region ========== ENUM HELPERS - STOCKTAKING TYPE ==========

        /// <summary>
        /// Load danh s√°ch StocktakingTypeEnum v√†o ComboBoxEdit
        /// </summary>
        private void LoadStocktakingTypeComboBox()
        {
            try
            {
                StocktakingTypeComboBoxEdit.Properties.Items.Clear();

                // Load t·∫•t c·∫£ c√°c gi√° tr·ªã enum v·ªõi m√†u s·∫Øc HTML
                foreach (StocktakingTypeEnum value in Enum.GetValues(typeof(StocktakingTypeEnum)))
                {
                    int index = (int)value; // S·ª≠ d·ª•ng gi√° tr·ªã enum l√†m index (0, 1, 2, 3)
                    string description = ApplicationEnumUtils.GetDescription(value);
                    string colorHex = GetStocktakingTypeColor(value);

                    // T·∫°o HTML v·ªõi m√†u s·∫Øc theo chu·∫©n DevExpress
                    string itemName = $"<color='{colorHex}'>{description}</color>";

                    // Insert v√†o ComboBox v·ªõi index ƒë·ªÉ s·∫Øp x·∫øp ƒë√∫ng th·ª© t·ª±
                    // N·∫øu index l·ªõn h∆°n s·ªë items hi·ªán t·∫°i, th√™m v√†o cu·ªëi
                    if (index >= StocktakingTypeComboBoxEdit.Properties.Items.Count)
                    {
                        StocktakingTypeComboBoxEdit.Properties.Items.Add(itemName);
                    }
                    else
                    {
                        StocktakingTypeComboBoxEdit.Properties.Items.Insert(index, itemName);
                    }
                }

                // C·∫•u h√¨nh ComboBox
                StocktakingTypeComboBoxEdit.Properties.TextEditStyle = DevExpress.XtraEditors.Controls.TextEditStyles.DisableTextEditor;
                StocktakingTypeComboBoxEdit.Properties.ShowDropDown = DevExpress.XtraEditors.Controls.ShowDropDown.SingleClick;

                // S·ª≠ d·ª•ng CustomDisplayText ƒë·ªÉ hi·ªÉn th·ªã Description v·ªõi m√†u s·∫Øc
                StocktakingTypeComboBoxEdit.Properties.CustomDisplayText += StocktakingTypeTextEdit_CustomDisplayText;
                
                // ƒêƒÉng k√Ω event khi ch·ªçn gi√° tr·ªã ƒë·ªÉ convert sang enum
                StocktakingTypeComboBoxEdit.SelectedIndexChanged += StocktakingTypeTextEdit_SelectedIndexChanged;
            }
            catch (Exception ex)
            {
                _logger.Error($"LoadStocktakingTypeComboBox: L·ªói load danh s√°ch lo·∫°i ki·ªÉm kho: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// L·∫•y m√†u s·∫Øc t∆∞∆°ng ·ª©ng v·ªõi lo·∫°i ki·ªÉm kho StocktakingTypeEnum
        /// </summary>
        /// <param name="stocktakingType">Lo·∫°i ki·ªÉm kho</param>
        /// <returns>T√™n m√†u (color name) theo chu·∫©n DevExpress</returns>
        private string GetStocktakingTypeColor(StocktakingTypeEnum stocktakingType)
        {
            return stocktakingType switch
            {
                StocktakingTypeEnum.Periodic => "blue",           // Blue - Ki·ªÉm kho ƒë·ªãnh k·ª≥
                StocktakingTypeEnum.AdHoc => "orange",            // Orange - Ki·ªÉm kho ƒë·ªôt xu·∫•t
                StocktakingTypeEnum.FullWarehouse => "green",     // Green - Ki·ªÉm kho to√†n b·ªô kho
                StocktakingTypeEnum.ByProductList => "purple",    // Purple - Ki·ªÉm kho theo danh s√°ch s·∫£n ph·∫©m
                _ => "gray"                                       // Gray - Kh√°c
            };
        }

        /// <summary>
        /// Event handler ƒë·ªÉ hi·ªÉn th·ªã Description v·ªõi m√†u s·∫Øc trong ComboBoxEdit
        /// </summary>
        private void StocktakingTypeTextEdit_CustomDisplayText(object sender, DevExpress.XtraEditors.Controls.CustomDisplayTextEventArgs e)
        {
            try
            {
                if (e.Value == null) return;

                StocktakingTypeEnum stocktakingTypeValue;

                // N·∫øu gi√° tr·ªã l√† string (Description v·ªõi HTML), convert v·ªÅ enum
                if (e.Value is string stringValue)
                {
                    var stocktakingTypeEnum = GetStocktakingTypeEnumFromDescription(stringValue);
                    if (!stocktakingTypeEnum.HasValue)
                    {
                        e.DisplayText = stringValue; // Gi·ªØ nguy√™n n·∫øu kh√¥ng convert ƒë∆∞·ª£c
                        return;
                    }
                    stocktakingTypeValue = stocktakingTypeEnum.Value;
                }
                else if (e.Value is StocktakingTypeEnum enumValue)
                {
                    stocktakingTypeValue = enumValue;
                }
                else if (e.Value is int intValue && Enum.IsDefined(typeof(StocktakingTypeEnum), intValue))
                {
                    stocktakingTypeValue = (StocktakingTypeEnum)intValue;
                }
                else
                {
                    return;
                }

                // L·∫•y Description v√† m√†u s·∫Øc
                var description = ApplicationEnumUtils.GetDescription(stocktakingTypeValue);
                var colorHex = GetStocktakingTypeColor(stocktakingTypeValue);

                // T·∫°o HTML v·ªõi m√†u s·∫Øc theo chu·∫©n DevExpress
                e.DisplayText = $"<color='{colorHex}'>{description}</color>";
            }
            catch (Exception ex)
            {
                _logger.Error($"StocktakingTypeTextEdit_CustomDisplayText: L·ªói hi·ªÉn th·ªã lo·∫°i ki·ªÉm kho: {ex.Message}", ex);
                // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã gi√° tr·ªã m·∫∑c ƒë·ªãnh
                e.DisplayText = e.Value?.ToString() ?? string.Empty;
            }
        }

        /// <summary>
        /// X·ª≠ l√Ω khi ch·ªçn gi√° tr·ªã t·ª´ ComboBox
        /// Convert SelectedIndex th√†nh enum v√† l∆∞u v√†o Tag ƒë·ªÉ c√≥ th·ªÉ l·∫•y l·∫°i sau
        /// </summary>
        private void StocktakingTypeTextEdit_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                var comboBoxEdit = sender as ComboBoxEdit;
                if (comboBoxEdit == null) return;

                var selectedIndex = comboBoxEdit.SelectedIndex;
                if (selectedIndex >= 0 && selectedIndex < comboBoxEdit.Properties.Items.Count)
                {
                    // Convert index th√†nh enum
                    if (Enum.IsDefined(typeof(StocktakingTypeEnum), selectedIndex))
                    {
                        var enumValue = (StocktakingTypeEnum)selectedIndex;
                        // L∆∞u enum value v√†o Tag ƒë·ªÉ c√≥ th·ªÉ l·∫•y l·∫°i sau
                        comboBoxEdit.Tag = enumValue;
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"StocktakingTypeTextEdit_SelectedIndexChanged: L·ªói x·ª≠ l√Ω thay ƒë·ªïi lo·∫°i ki·ªÉm kho: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// L·∫•y gi√° tr·ªã enum hi·ªán t·∫°i t·ª´ ComboBox
        /// </summary>
        /// <returns>StocktakingTypeEnum ho·∫∑c null</returns>
        private StocktakingTypeEnum? GetSelectedStocktakingType()
        {
            try
            {
                var selectedIndex = StocktakingTypeComboBoxEdit.SelectedIndex;
                if (selectedIndex >= 0 && Enum.IsDefined(typeof(StocktakingTypeEnum), selectedIndex))
                {
                    return (StocktakingTypeEnum)selectedIndex;
                }

                // Fallback: L·∫•y t·ª´ Tag n·∫øu c√≥
                if (StocktakingTypeComboBoxEdit.Tag is StocktakingTypeEnum enumValue)
                {
                    return enumValue;
                }

                return null;
            }
            catch
            {
                return null;
            }
        }

        /// <summary>
        /// Set gi√° tr·ªã enum v√†o ComboBox
        /// </summary>
        /// <param name="stocktakingType">Gi√° tr·ªã enum c·∫ßn set</param>
        private void SetStocktakingType(StocktakingTypeEnum stocktakingType)
        {
            try
            {
                var index = (int)stocktakingType;
                if (index >= 0 && index < StocktakingTypeComboBoxEdit.Properties.Items.Count)
                {
                    StocktakingTypeComboBoxEdit.SelectedIndex = index;
                    StocktakingTypeComboBoxEdit.Tag = stocktakingType;
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"SetStocktakingType: L·ªói set lo·∫°i ki·ªÉm kho: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// Set gi√° tr·ªã enum v√†o ComboBox Status
        /// </summary>
        /// <param name="stocktakingStatus">Gi√° tr·ªã enum c·∫ßn set</param>
        private void SetStocktakingStatus(StocktakingStatusEnum stocktakingStatus)
        {
            try
            {
                var index = (int)stocktakingStatus;
                if (index >= 0 && index < StocktakingStatusComboBoxEdit.Properties.Items.Count)
                {
                    StocktakingStatusComboBoxEdit.SelectedIndex = index;
                    StocktakingStatusComboBoxEdit.Tag = stocktakingStatus;
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"SetStocktakingStatus: L·ªói set tr·∫°ng th√°i ki·ªÉm kho: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// L·∫•y enum t·ª´ description (lo·∫°i b·ªè HTML tags)
        /// </summary>
        private StocktakingTypeEnum? GetStocktakingTypeEnumFromDescription(string description)
        {
            if (string.IsNullOrWhiteSpace(description))
                return null;

            // Lo·∫°i b·ªè HTML tags n·∫øu c√≥
            var cleanDescription = description;
            if (description.Contains("<color"))
            {
                // Extract text t·ª´ HTML: <color='xxx'>Text</color>
                var startIndex = description.IndexOf('>') + 1;
                var endIndex = description.LastIndexOf('<');
                if (startIndex > 0 && endIndex > startIndex)
                {
                    cleanDescription = description.Substring(startIndex, endIndex - startIndex);
                }
            }

            // T√¨m enum value t·ª´ description
            foreach (StocktakingTypeEnum value in Enum.GetValues(typeof(StocktakingTypeEnum)))
            {
                var enumDescription = ApplicationEnumUtils.GetDescription(value);
                if (string.Equals(enumDescription, cleanDescription, StringComparison.OrdinalIgnoreCase))
                {
                    return value;
                }
            }

            return null;
        }

        #endregion

        #region ========== ENUM HELPERS - STOCKTAKING STATUS ==========

        /// <summary>
        /// Load danh s√°ch StocktakingStatusEnum v√†o ComboBoxEdit
        /// </summary>
        private void LoadStocktakingStatusComboBox()
        {
            try
            {
                StocktakingStatusComboBoxEdit.Properties.Items.Clear();

                // Load t·∫•t c·∫£ c√°c gi√° tr·ªã enum v·ªõi m√†u s·∫Øc HTML
                foreach (StocktakingStatusEnum value in Enum.GetValues(typeof(StocktakingStatusEnum)))
                {
                    int index = (int)value; // S·ª≠ d·ª•ng gi√° tr·ªã enum l√†m index (0, 1, 2, 3, 4)
                    string description = ApplicationEnumUtils.GetDescription(value);
                    string colorHex = GetStocktakingStatusColor(value);

                    // T·∫°o HTML v·ªõi m√†u s·∫Øc theo chu·∫©n DevExpress
                    string itemName = $"<color='{colorHex}'>{description}</color>";

                    // Insert v√†o ComboBox v·ªõi index ƒë·ªÉ s·∫Øp x·∫øp ƒë√∫ng th·ª© t·ª±
                    // N·∫øu index l·ªõn h∆°n s·ªë items hi·ªán t·∫°i, th√™m v√†o cu·ªëi
                    if (index >= StocktakingStatusComboBoxEdit.Properties.Items.Count)
                    {
                        StocktakingStatusComboBoxEdit.Properties.Items.Add(itemName);
                    }
                    else
                    {
                        StocktakingStatusComboBoxEdit.Properties.Items.Insert(index, itemName);
                    }
                }

                // C·∫•u h√¨nh ComboBox (CheckedComboBoxEdit c√≥ th·ªÉ d√πng nh∆∞ ComboBoxEdit khi ch·ªâ ch·ªçn 1 gi√° tr·ªã)
                StocktakingStatusComboBoxEdit.Properties.TextEditStyle = DevExpress.XtraEditors.Controls.TextEditStyles.DisableTextEditor;
                StocktakingStatusComboBoxEdit.Properties.ShowDropDown = DevExpress.XtraEditors.Controls.ShowDropDown.SingleClick;

                // S·ª≠ d·ª•ng CustomDisplayText ƒë·ªÉ hi·ªÉn th·ªã Description v·ªõi m√†u s·∫Øc
                StocktakingStatusComboBoxEdit.Properties.CustomDisplayText += StocktakingStatusComboBoxEdit_CustomDisplayText;
                
                // ƒêƒÉng k√Ω event khi ch·ªçn gi√° tr·ªã ƒë·ªÉ convert sang enum
                StocktakingStatusComboBoxEdit.SelectedIndexChanged += StocktakingStatusComboBoxEdit_SelectedIndexChanged;
            }
            catch (Exception ex)
            {
                _logger.Error($"LoadStocktakingStatusComboBox: L·ªói load danh s√°ch tr·∫°ng th√°i ki·ªÉm kho: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// L·∫•y m√†u s·∫Øc t∆∞∆°ng ·ª©ng v·ªõi tr·∫°ng th√°i ki·ªÉm kho StocktakingStatusEnum
        /// </summary>
        /// <param name="stocktakingStatus">Tr·∫°ng th√°i ki·ªÉm kho</param>
        /// <returns>T√™n m√†u (color name) theo chu·∫©n DevExpress</returns>
        private string GetStocktakingStatusColor(StocktakingStatusEnum stocktakingStatus)
        {
            return stocktakingStatus switch
            {
                StocktakingStatusEnum.Draft => "gray",           // Gray - Nh√°p
                StocktakingStatusEnum.InProgress => "blue",      // Blue - ƒêang ki·ªÉm
                StocktakingStatusEnum.Completed => "green",     // Green - Ho√†n th√†nh
                StocktakingStatusEnum.Approved => "darkgreen",  // Dark Green - ƒê√£ duy·ªát
                StocktakingStatusEnum.Cancelled => "red",       // Red - ƒê√£ h·ªßy
                _ => "gray"                                      // Gray - Kh√°c
            };
        }

        /// <summary>
        /// Event handler ƒë·ªÉ hi·ªÉn th·ªã Description v·ªõi m√†u s·∫Øc trong ComboBoxEdit
        /// </summary>
        private void StocktakingStatusComboBoxEdit_CustomDisplayText(object sender, DevExpress.XtraEditors.Controls.CustomDisplayTextEventArgs e)
        {
            try
            {
                if (e.Value == null) return;

                StocktakingStatusEnum stocktakingStatusValue;

                // N·∫øu gi√° tr·ªã l√† string (Description v·ªõi HTML), convert v·ªÅ enum
                if (e.Value is string stringValue)
                {
                    var stocktakingStatusEnum = GetStocktakingStatusEnumFromDescription(stringValue);
                    if (!stocktakingStatusEnum.HasValue)
                    {
                        e.DisplayText = stringValue; // Gi·ªØ nguy√™n n·∫øu kh√¥ng convert ƒë∆∞·ª£c
                        return;
                    }
                    stocktakingStatusValue = stocktakingStatusEnum.Value;
                }
                else if (e.Value is StocktakingStatusEnum enumValue)
                {
                    stocktakingStatusValue = enumValue;
                }
                else if (e.Value is int intValue && Enum.IsDefined(typeof(StocktakingStatusEnum), intValue))
                {
                    stocktakingStatusValue = (StocktakingStatusEnum)intValue;
                }
                else
                {
                    return;
                }

                // L·∫•y Description v√† m√†u s·∫Øc
                var description = ApplicationEnumUtils.GetDescription(stocktakingStatusValue);
                var colorHex = GetStocktakingStatusColor(stocktakingStatusValue);

                // T·∫°o HTML v·ªõi m√†u s·∫Øc theo chu·∫©n DevExpress
                e.DisplayText = $"<color='{colorHex}'>{description}</color>";
            }
            catch (Exception ex)
            {
                _logger.Error($"StocktakingStatusComboBoxEdit_CustomDisplayText: L·ªói hi·ªÉn th·ªã tr·∫°ng th√°i ki·ªÉm kho: {ex.Message}", ex);
                // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã gi√° tr·ªã m·∫∑c ƒë·ªãnh
                e.DisplayText = e.Value?.ToString() ?? string.Empty;
            }
        }

        /// <summary>
        /// X·ª≠ l√Ω khi ch·ªçn gi√° tr·ªã t·ª´ ComboBox
        /// Convert SelectedIndex th√†nh enum v√† l∆∞u v√†o Tag ƒë·ªÉ c√≥ th·ªÉ l·∫•y l·∫°i sau
        /// </summary>
        private void StocktakingStatusComboBoxEdit_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                var comboBoxEdit = sender as ComboBoxEdit;
                if (comboBoxEdit == null) return;

                var selectedIndex = comboBoxEdit.SelectedIndex;
                if (selectedIndex >= 0 && selectedIndex < comboBoxEdit.Properties.Items.Count)
                {
                    // Convert index th√†nh enum
                    if (Enum.IsDefined(typeof(StocktakingStatusEnum), selectedIndex))
                    {
                        var enumValue = (StocktakingStatusEnum)selectedIndex;
                        // L∆∞u enum value v√†o Tag ƒë·ªÉ c√≥ th·ªÉ l·∫•y l·∫°i sau
                        comboBoxEdit.Tag = enumValue;
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"StocktakingStatusComboBoxEdit_SelectedIndexChanged: L·ªói x·ª≠ l√Ω thay ƒë·ªïi tr·∫°ng th√°i ki·ªÉm kho: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// L·∫•y enum t·ª´ description (lo·∫°i b·ªè HTML tags)
        /// </summary>
        private StocktakingStatusEnum? GetStocktakingStatusEnumFromDescription(string description)
        {
            if (string.IsNullOrWhiteSpace(description))
                return null;

            // Lo·∫°i b·ªè HTML tags n·∫øu c√≥
            var cleanDescription = description;
            if (description.Contains("<color"))
            {
                // Extract text t·ª´ HTML: <color='xxx'>Text</color>
                var startIndex = description.IndexOf('>') + 1;
                var endIndex = description.LastIndexOf('<');
                if (startIndex > 0 && endIndex > startIndex)
                {
                    cleanDescription = description.Substring(startIndex, endIndex - startIndex);
                }
            }

            // T√¨m enum value t·ª´ description
            foreach (StocktakingStatusEnum value in Enum.GetValues(typeof(StocktakingStatusEnum)))
            {
                var enumDescription = ApplicationEnumUtils.GetDescription(value);
                if (string.Equals(enumDescription, cleanDescription, StringComparison.OrdinalIgnoreCase))
                {
                    return value;
                }
            }

            return null;
        }

        /// <summary>
        /// L·∫•y gi√° tr·ªã enum hi·ªán t·∫°i t·ª´ ComboBox Status
        /// </summary>
        /// <returns>StocktakingStatusEnum ho·∫∑c null</returns>
        private StocktakingStatusEnum? GetSelectedStocktakingStatus()
        {
            try
            {
                var selectedIndex = StocktakingStatusComboBoxEdit.SelectedIndex;
                if (selectedIndex >= 0 && Enum.IsDefined(typeof(StocktakingStatusEnum), selectedIndex))
                {
                    return (StocktakingStatusEnum)selectedIndex;
                }

                // Fallback: L·∫•y t·ª´ Tag n·∫øu c√≥
                if (StocktakingStatusComboBoxEdit.Tag is StocktakingStatusEnum enumValue)
                {
                    return enumValue;
                }

                return null;
            }
            catch
            {
                return null;
            }
        }

        #endregion

        #region ========== DATA LOADING ==========

        /// <summary>
        /// Load d·ªØ li·ªáu t·ª´ database khi ·ªü ch·∫ø ƒë·ªô ƒëi·ªÅu ch·ªânh
        /// </summary>
        private async void LoadExistingData()
        {
            try
            {
                _logger.Debug($"LoadExistingData: B·∫Øt ƒë·∫ßu load d·ªØ li·ªáu, Id={_stocktakingMasterId}");

                // ƒê·∫£m b·∫£o datasource ƒë√£ ƒë∆∞·ª£c load tr∆∞·ªõc
                await LoadWarehouseDataSourceAsync();

                // L·∫•y DTO t·ª´ BLL
                var dto = _stocktakingMasterBll.GetById(_stocktakingMasterId);
                if (dto == null)
                {
                    throw new InvalidOperationException($"Kh√¥ng t√¨m th·∫•y phi·∫øu ki·ªÉm kho v·ªõi ID: {_stocktakingMasterId}");
                }

                _logger.Info($"LoadExistingData: ƒê√£ load d·ªØ li·ªáu th√†nh c√¥ng, VoucherNumber={dto.VoucherNumber}");

                // Load d·ªØ li·ªáu v√†o c√°c controls
                // Th√¥ng tin c∆° b·∫£n
                StocktakingDateDateEdit.DateTime = dto.StocktakingDate;
                VoucherNumberTextEdit.Text = dto.VoucherNumber;
                
                // Set enum values
                SetStocktakingType(dto.StocktakingType);
                SetStocktakingStatus(dto.StocktakingStatus);

                // Kho ki·ªÉm - set sau khi datasource ƒë√£ load
                WarehouseNameSearchLookupEdit.EditValue = dto.WarehouseId;

                // Th·ªùi gian ki·ªÉm kho
                if (dto.StartDate.HasValue)
                    StartDateDateEdit.EditValue = dto.StartDate.Value;
                if (dto.EndDate.HasValue)
                    EndDateDateEdit.EditValue = dto.EndDate.Value;

                // Quy tr√¨nh ph√™ duy·ªát
                if (dto.CountedDate.HasValue)
                    CountedDateDateEdit.EditValue = dto.CountedDate.Value;
                if (dto.ReviewedDate.HasValue)
                    ReviewedDateDateEdit.EditValue = dto.ReviewedDate.Value;
                if (dto.ApprovedDate.HasValue)
                    ApprovedDateDateEdit.EditValue = dto.ApprovedDate.Value;

                // Th√¥ng tin b·ªï sung
                NotesTextEdit.Text = dto.Notes ?? string.Empty;
                ReasonTextEdit.Text = dto.Reason ?? string.Empty;

                // Kh√≥a phi·∫øu
                IsLockedToggleSwitch.EditValue = dto.IsLocked;

                // Disable s·ªë phi·∫øu n·∫øu ƒë√£ l∆∞u (kh√¥ng cho ph√©p ch·ªânh s·ª≠a)
                if (!string.IsNullOrEmpty(dto.VoucherNumber))
                {
                    VoucherNumberTextEdit.Properties.ReadOnly = true;
                    _isVoucherNumberAutoGenerated = false; // Kh√¥ng t·ª± ƒë·ªông t·∫°o l·∫°i khi edit
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"LoadExistingData: L·ªói load d·ªØ li·ªáu: {ex.Message}", ex);
                ShowError(ex, "L·ªói t·∫£i d·ªØ li·ªáu phi·∫øu ki·ªÉm kho");
                throw;
            }
        }

        /// <summary>
        /// Load datasource cho Warehouse (CompanyBranch) - Load to√†n b·ªô danh s√°ch
        /// </summary>
        private async Task LoadWarehouseDataSourceAsync()
        {
            try
            {
                companyBranchDtoBindingSource.DataSource = await Task.Run(() => _companyBranchBll.GetAll());
            }
            catch (Exception ex)
            {
                _logger.Error($"LoadWarehouseDataSourceAsync: L·ªói t·∫£i d·ªØ li·ªáu kho: {ex.Message}", ex);
                ShowError(ex, "L·ªói t·∫£i d·ªØ li·ªáu kho");
            }
        }

        /// <summary>
        /// X·ª≠ l√Ω khi m·ªü popup c·ªßa WarehouseNameSearchLookupEdit
        /// Load l·∫°i d·ªØ li·ªáu ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ d·ªØ li·ªáu m·ªõi nh·∫•t
        /// </summary>
        private async void WarehouseNameSearchLookupEdit_Popup(object sender, EventArgs e)
        {
            try
            {
                await LoadWarehouseDataSourceAsync();
            }
            catch (Exception ex)
            {
                _logger.Error($"WarehouseNameSearchLookupEdit_Popup: L·ªói t·∫£i d·ªØ li·ªáu kho: {ex.Message}", ex);
                ShowError(ex, "L·ªói t·∫£i d·ªØ li·ªáu kho");
            }
        }

        #endregion

        #region ========== EVENT HANDLERS ==========

        /// <summary>
        /// X·ª≠ l√Ω khi click n√∫t L∆∞u
        /// </summary>
        private async void SaveBarButtonItem_ItemClick(object sender, ItemClickEventArgs e)
        {
            try
            {
                _logger.Debug("SaveBarButtonItem_ItemClick: B·∫Øt ƒë·∫ßu l∆∞u phi·∫øu ki·ªÉm kho");

                // Validate d·ªØ li·ªáu tr∆∞·ªõc khi l∆∞u
                if (!ValidateInput())
                {
                    _logger.Warning("SaveBarButtonItem_ItemClick: Validation th·∫•t b·∫°i");
                    return;
                }

                // L·∫•y DTO t·ª´ form
                var dto = GetDto();
                if (dto == null)
                {
                    _logger.Warning("SaveBarButtonItem_ItemClick: Kh√¥ng th·ªÉ l·∫•y DTO t·ª´ form");
                    ShowError("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ form. Vui l√≤ng ki·ªÉm tra l·∫°i.");
                    return;
                }

                // L∆∞u v√†o database
                var savedDto = await Task.Run(() => _stocktakingMasterBll.SaveOrUpdate(dto));
                
                if (savedDto != null)
                {
                    _logger.Info($"SaveBarButtonItem_ItemClick: L∆∞u phi·∫øu ki·ªÉm kho th√†nh c√¥ng, Id={savedDto.Id}, VoucherNumber={savedDto.VoucherNumber}");
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                    var parentForm = FindForm();
                    MsgBox.ShowSuccess("L∆∞u phi·∫øu ki·ªÉm kho th√†nh c√¥ng!", "Th√†nh c√¥ng", parentForm);
                    
                    // ƒê√≥ng form v√† tr·∫£ v·ªÅ DialogResult.OK
                    DialogResult = System.Windows.Forms.DialogResult.OK;
                    Close();
                }
                else
                {
                    _logger.Warning("SaveBarButtonItem_ItemClick: L∆∞u phi·∫øu ki·ªÉm kho th·∫•t b·∫°i - savedDto is null");
                    ShowError("L∆∞u phi·∫øu ki·ªÉm kho th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
                }
            }
            catch (Exception ex)
            {
                _logger.Error($"SaveBarButtonItem_ItemClick: L·ªói l∆∞u phi·∫øu ki·ªÉm kho: {ex.Message}", ex);
                ShowError(ex, "L·ªói l∆∞u phi·∫øu ki·ªÉm kho");
            }
        }

        /// <summary>
        /// X·ª≠ l√Ω khi click n√∫t ƒê√≥ng
        /// </summary>
        private void CloseBarButtonItem_ItemClick(object sender, ItemClickEventArgs e)
        {
            try
            {
                _logger.Debug("CloseBarButtonItem_ItemClick: ƒê√≥ng form");
                
                // ƒê√≥ng form v√† tr·∫£ v·ªÅ DialogResult.Cancel
                DialogResult = System.Windows.Forms.DialogResult.Cancel;
                Close();
            }
            catch (Exception ex)
            {
                _logger.Error($"CloseBarButtonItem_ItemClick: L·ªói ƒë√≥ng form: {ex.Message}", ex);
                ShowError(ex, "L·ªói ƒë√≥ng form");
            }
        }

        #endregion

        #region ========== VALIDATION ==========

        /// <summary>
        /// Validate d·ªØ li·ªáu input v√† hi·ªÉn th·ªã l·ªói b·∫±ng dxErrorProvider
        /// </summary>
        private bool ValidateInput()
        {
            try
            {
                dxErrorProvider1.ClearErrors();

                // Ng√†y ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng
                if (StocktakingDateDateEdit.EditValue is null)
                {
                    dxErrorProvider1.SetError(StocktakingDateDateEdit, "Ng√†y ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
                    return false;
                }

                // S·ªë phi·∫øu kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng
                if (string.IsNullOrWhiteSpace(VoucherNumberTextEdit.Text))
                {
                    dxErrorProvider1.SetError(VoucherNumberTextEdit, "S·ªë phi·∫øu ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
                    return false;
                }

                // Ki·ªÉm tra ƒë·ªô d√†i s·ªë phi·∫øu (t·ªëi ƒëa 50 k√Ω t·ª±)
                if (VoucherNumberTextEdit.Text.Length > 50)
                {
                    dxErrorProvider1.SetError(VoucherNumberTextEdit, "S·ªë phi·∫øu ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50 k√Ω t·ª±");
                    return false;
                }

                // Lo·∫°i ki·ªÉm kho ph·∫£i ƒë∆∞·ª£c ch·ªçn
                var selectedType = GetSelectedStocktakingType();
                if (!selectedType.HasValue)
                {
                    dxErrorProvider1.SetError(StocktakingTypeComboBoxEdit, "Lo·∫°i ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
                    return false;
                }

                // Tr·∫°ng th√°i ki·ªÉm kho ph·∫£i ƒë∆∞·ª£c ch·ªçn
                var selectedStatus = GetSelectedStocktakingStatus();
                if (!selectedStatus.HasValue)
                {
                    dxErrorProvider1.SetError(StocktakingStatusComboBoxEdit, "Tr·∫°ng th√°i ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
                    return false;
                }

                // Kho ki·ªÉm kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng
                if (WarehouseNameSearchLookupEdit.EditValue is not Guid warehouseId || warehouseId == Guid.Empty)
                {
                    dxErrorProvider1.SetError(WarehouseNameSearchLookupEdit, "Kho ki·ªÉm kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
                    return false;
                }

                return true;
            }
            catch (Exception ex)
            {
                _logger.Error($"ValidateInput: L·ªói validate d·ªØ li·ªáu: {ex.Message}", ex);
                ShowError(ex, "L·ªói validate d·ªØ li·ªáu");
                return false;
            }
        }

        #endregion

        #region ========== DATA CONVERSION ==========

        /// <summary>
        /// L·∫•y DTO t·ª´ c√°c control sau khi validate c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
        /// </summary>
        /// <returns>StocktakingMasterDto n·∫øu validation th√†nh c√¥ng, null n·∫øu c√≥ l·ªói</returns>
        private StocktakingMasterDto GetDto()
        {
            try
            {
                // Validate c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
                if (!ValidateInput())
                {
                    return null; // Validation th·∫•t b·∫°i
                }

                // L·∫•y c√°c gi√° tr·ªã t·ª´ controls
                var stocktakingDate = StocktakingDateDateEdit.DateTime;
                var voucherNumber = VoucherNumberTextEdit.Text?.Trim() ?? string.Empty;
                var selectedType = GetSelectedStocktakingType();
                var selectedStatus = GetSelectedStocktakingStatus();
                var warehouseId = WarehouseNameSearchLookupEdit.EditValue is Guid wId ? wId : Guid.Empty;

                // Ki·ªÉm tra c√°c gi√° tr·ªã b·∫Øt bu·ªôc
                if (stocktakingDate == DateTime.MinValue || !selectedType.HasValue || !selectedStatus.HasValue || warehouseId == Guid.Empty)
                {
                    return null;
                }

                // T·∫°o DTO
                var dto = new StocktakingMasterDto
                {
                    // Th√¥ng tin c∆° b·∫£n
                    Id = _stocktakingMasterId,
                    StocktakingDate = stocktakingDate,
                    VoucherNumber = voucherNumber,
                    StocktakingType = selectedType.Value,
                    StocktakingStatus = selectedStatus.Value,
                    WarehouseId = warehouseId,
                    CompanyBranchId = warehouseId, // CompanyBranchId = WarehouseId (v√¨ warehouse l√† company branch)

                    // Th·ªùi gian ki·ªÉm kho
                    StartDate = StartDateDateEdit.EditValue is DateTime startDate ? startDate : null,
                    EndDate = EndDateDateEdit.EditValue is DateTime endDate ? endDate : null,

                    // Quy tr√¨nh ph√™ duy·ªát
                    CountedDate = CountedDateDateEdit.EditValue is DateTime countedDate ? countedDate : null,
                    ReviewedDate = ReviewedDateDateEdit.EditValue is DateTime reviewedDate ? reviewedDate : null,
                    ApprovedDate = ApprovedDateDateEdit.EditValue is DateTime approvedDate ? approvedDate : null,

                    // Th√¥ng tin b·ªï sung
                    Notes = NotesTextEdit.Text?.Trim() ?? string.Empty,
                    Reason = ReasonTextEdit.Text?.Trim() ?? string.Empty,

                    // Kh√≥a phi·∫øu
                    IsLocked = IsLockedToggleSwitch.EditValue is bool isLocked && isLocked,
                    LockedDate = IsLockedToggleSwitch.EditValue is bool locked && locked ? DateTime.Now : null,

                    // Tr·∫°ng th√°i
                    IsActive = true,
                    IsDeleted = false,

                    // Audit fields
                    CreatedDate = _stocktakingMasterId == Guid.Empty ? DateTime.Now : null,
                    UpdatedDate = DateTime.Now
                };

                return dto;
            }
            catch (Exception ex)
            {
                _logger.Error($"GetDto: L·ªói l·∫•y d·ªØ li·ªáu t·ª´ form: {ex.Message}", ex);
                ShowError(ex, "L·ªói l·∫•y d·ªØ li·ªáu");
                return null;
            }
        }

        #endregion

        #region ========== SUPERTOOLTIP ==========

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho t·∫•t c·∫£ c√°c controls trong form
        /// </summary>
        private void SetupSuperToolTips()
        {
            try
            {
                SetupBarButtonSuperTips();
                SetupTextEditSuperTips();
                SetupDateEditSuperTips();
                SetupComboBoxEditSuperTips();
                SetupSearchLookupEditSuperTips();
                SetupMemoEditSuperTips();
                SetupToggleSwitchSuperTips();
            }
            catch (Exception ex)
            {
                _logger.Error($"SetupSuperToolTips: L·ªói thi·∫øt l·∫≠p SuperToolTip: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho c√°c BarButton controls
        /// </summary>
        private void SetupBarButtonSuperTips()
        {
            // SuperTip cho n√∫t L∆∞u
            if (SaveBarButtonItem != null)
            {
                SuperToolTipHelper.SetBarButtonSuperTip(
                    SaveBarButtonItem,
                    title: @"<b><color=Green>üíæ L∆∞u</color></b>",
                    content: @"L∆∞u phi·∫øu ki·ªÉm kho v√†o database.<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ Validate d·ªØ li·ªáu tr∆∞·ªõc khi l∆∞u<br/>‚Ä¢ L∆∞u th√¥ng tin phi·∫øu ki·ªÉm kho v√†o database<br/>‚Ä¢ ƒê√≥ng form sau khi l∆∞u th√†nh c√¥ng<br/><br/><b>Quy tr√¨nh:</b><br/>1. Validate c√°c tr∆∞·ªùng b·∫Øt bu·ªôc<br/>2. L·∫•y d·ªØ li·ªáu t·ª´ form<br/>3. G·ªçi BLL.SaveOrUpdate() ƒë·ªÉ l∆∞u<br/>4. Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng<br/>5. ƒê√≥ng form<br/><br/><b>Validation:</b><br/>‚Ä¢ Ng√†y ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng<br/>‚Ä¢ S·ªë phi·∫øu kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng (t·ªëi ƒëa 50 k√Ω t·ª±)<br/>‚Ä¢ Lo·∫°i ki·ªÉm kho ph·∫£i ƒë∆∞·ª£c ch·ªçn<br/>‚Ä¢ Tr·∫°ng th√°i ki·ªÉm kho ph·∫£i ƒë∆∞·ª£c ch·ªçn<br/>‚Ä¢ Kho ki·ªÉm kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng<br/><br/><color=Gray>L∆∞u √Ω:</color> H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o s·ªë phi·∫øu n·∫øu ch∆∞a c√≥."
                );
            }

            // SuperTip cho n√∫t ƒê√≥ng
            if (CloseBarButtonItem != null)
            {
                SuperToolTipHelper.SetBarButtonSuperTip(
                    CloseBarButtonItem,
                    title: @"<b><color=Red>‚ùå ƒê√≥ng</color></b>",
                    content: @"ƒê√≥ng form v√† kh√¥ng l∆∞u d·ªØ li·ªáu.<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ ƒê√≥ng form hi·ªán t·∫°i<br/>‚Ä¢ Kh√¥ng l∆∞u d·ªØ li·ªáu v√†o database<br/>‚Ä¢ H·ªßy b·ªè m·ªçi thay ƒë·ªïi ch∆∞a l∆∞u<br/><br/><color=Gray>L∆∞u √Ω:</color> N·∫øu b·∫°n ƒë√£ ch·ªânh s·ª≠a phi·∫øu ki·ªÉm kho, h√£y nh·ªõ click <b>L∆∞u</b> tr∆∞·ªõc khi ƒë√≥ng form."
                );
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho c√°c TextEdit controls
        /// </summary>
        private void SetupTextEditSuperTips()
        {
            // SuperTip cho S·ªë phi·∫øu ki·ªÉm kho
            if (VoucherNumberTextEdit != null)
            {
                SuperToolTipHelper.SetTextEditSuperTip(
                    VoucherNumberTextEdit,
                    title: @"<b><color=DarkBlue>üìÑ S·ªë phi·∫øu ki·ªÉm kho</color></b>",
                    content: @"S·ªë phi·∫øu ki·ªÉm kho ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông theo format: <b>KK-YYYY-XXX</b><br/><br/><b>Format:</b><br/>‚Ä¢ KK: Ki·ªÉm kho<br/>‚Ä¢ YYYY: NƒÉm (4 k√Ω t·ª±)<br/>‚Ä¢ XXX: S·ªë th·ª© t·ª± phi·∫øu (3 k√Ω t·ª± t·ª´ 001 ƒë·∫øn 999)<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ T·ª± ƒë·ªông t·∫°o khi thay ƒë·ªïi ng√†y ki·ªÉm kho<br/>‚Ä¢ Query database ƒë·ªÉ l·∫•y s·ªë th·ª© t·ª± ti·∫øp theo<br/>‚Ä¢ ƒê·∫£m b·∫£o s·ªë phi·∫øu duy nh·∫•t trong c√πng nƒÉm<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <b><color=Red>B·∫Øt bu·ªôc nh·∫≠p</color></b> (c√≥ d·∫•u * ƒë·ªè)<br/>‚Ä¢ Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng<br/>‚Ä¢ T·ªëi ƒëa 50 k√Ω t·ª±<br/><br/><b>Validation:</b><br/>‚Ä¢ Ki·ªÉm tra r·ªóng khi validating<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói: ""S·ªë phi·∫øu ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng""<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói qua ErrorProvider n·∫øu kh√¥ng h·ª£p l·ªá<br/><br/><color=Gray>L∆∞u √Ω:</color> S·ªë phi·∫øu ki·ªÉm kho s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o database khi l∆∞u phi·∫øu ki·ªÉm kho."
                );
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho c√°c DateEdit controls
        /// </summary>
        private void SetupDateEditSuperTips()
        {
            // SuperTip cho Ng√†y ki·ªÉm kho
            if (StocktakingDateDateEdit != null)
            {
                SuperToolTipHelper.SetBaseEditSuperTip(
                    StocktakingDateDateEdit,
                    title: @"<b><color=DarkBlue>üìÖ Ng√†y ki·ªÉm kho</color></b>",
                    content: @"Ch·ªçn ng√†y ki·ªÉm kho cho phi·∫øu ki·ªÉm.<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ X√°c ƒë·ªãnh th·ªùi ƒëi·ªÉm ki·ªÉm kho<br/>‚Ä¢ T·ª± ƒë·ªông t·∫°o s·ªë phi·∫øu ki·ªÉm kho d·ª±a tr√™n ng√†y<br/>‚Ä¢ Format s·ªë phi·∫øu: KK-YYYY-XXX (YYYY t·ª´ ng√†y n√†y)<br/>‚Ä¢ Query database ƒë·ªÉ l·∫•y s·ªë th·ª© t·ª± ti·∫øp theo trong nƒÉm<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <b><color=Red>B·∫Øt bu·ªôc nh·∫≠p</color></b> (c√≥ d·∫•u * ƒë·ªè)<br/>‚Ä¢ Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng<br/>‚Ä¢ M·∫∑c ƒë·ªãnh: Ng√†y hi·ªán t·∫°i<br/><br/><b>Validation:</b><br/>‚Ä¢ Ki·ªÉm tra r·ªóng khi validating<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói: ""Ng√†y ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng""<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói qua ErrorProvider n·∫øu kh√¥ng h·ª£p l·ªá<br/><br/><color=Gray>L∆∞u √Ω:</color> Khi thay ƒë·ªïi ng√†y ki·ªÉm kho, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o l·∫°i s·ªë phi·∫øu ki·ªÉm kho theo format m·ªõi."
                );
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho c√°c ComboBoxEdit controls
        /// </summary>
        private void SetupComboBoxEditSuperTips()
        {
            // SuperTip cho Lo·∫°i ki·ªÉm kho
            if (StocktakingTypeComboBoxEdit != null)
            {
                SuperToolTipHelper.SetBaseEditSuperTip(
                    StocktakingTypeComboBoxEdit,
                    title: @"<b><color=DarkBlue>üìã Lo·∫°i ki·ªÉm kho</color></b>",
                    content: @"Ch·ªçn lo·∫°i ki·ªÉm kho t·ª´ danh s√°ch.<br/><br/><b>C√°c lo·∫°i ki·ªÉm kho:</b><br/>‚Ä¢ <color=Blue>Ki·ªÉm kho ƒë·ªãnh k·ª≥</color>: Ki·ªÉm kho theo l·ªãch ƒë·ªãnh k·ª≥<br/>‚Ä¢ <color=Orange>Ki·ªÉm kho ƒë·ªôt xu·∫•t</color>: Ki·ªÉm kho kh√¥ng theo l·ªãch<br/>‚Ä¢ <color=Green>Ki·ªÉm kho to√†n b·ªô kho</color>: Ki·ªÉm to√†n b·ªô s·∫£n ph·∫©m trong kho<br/>‚Ä¢ <color=Purple>Ki·ªÉm kho theo danh s√°ch s·∫£n ph·∫©m</color>: Ki·ªÉm theo danh s√°ch c·ª• th·ªÉ<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <b><color=Red>B·∫Øt bu·ªôc ch·ªçn</color></b> (c√≥ d·∫•u * ƒë·ªè)<br/>‚Ä¢ Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng<br/><br/><b>Validation:</b><br/>‚Ä¢ Ki·ªÉm tra r·ªóng khi validating<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói: ""Lo·∫°i ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng""<br/><br/><color=Gray>L∆∞u √Ω:</color> Lo·∫°i ki·ªÉm kho s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o database khi l∆∞u phi·∫øu ki·ªÉm kho."
                );
            }

            // SuperTip cho Tr·∫°ng th√°i ki·ªÉm kho
            if (StocktakingStatusComboBoxEdit != null)
            {
                SuperToolTipHelper.SetBaseEditSuperTip(
                    StocktakingStatusComboBoxEdit,
                    title: @"<b><color=DarkBlue>üìä Tr·∫°ng th√°i ki·ªÉm kho</color></b>",
                    content: @"Ch·ªçn tr·∫°ng th√°i ki·ªÉm kho t·ª´ danh s√°ch.<br/><br/><b>C√°c tr·∫°ng th√°i:</b><br/>‚Ä¢ <color=Gray>Nh√°p</color>: Phi·∫øu m·ªõi t·∫°o, ch∆∞a b·∫Øt ƒë·∫ßu ki·ªÉm<br/>‚Ä¢ <color=Blue>ƒêang ki·ªÉm</color>: ƒêang trong qu√° tr√¨nh ki·ªÉm kho<br/>‚Ä¢ <color=Green>Ho√†n th√†nh</color>: ƒê√£ ho√†n th√†nh ki·ªÉm kho<br/>‚Ä¢ <color=DarkGreen>ƒê√£ duy·ªát</color>: ƒê√£ ƒë∆∞·ª£c duy·ªát v√† x√°c nh·∫≠n<br/>‚Ä¢ <color=Red>ƒê√£ h·ªßy</color>: ƒê√£ b·ªã h·ªßy b·ªè<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <b><color=Red>B·∫Øt bu·ªôc ch·ªçn</color></b> (c√≥ d·∫•u * ƒë·ªè)<br/>‚Ä¢ Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng<br/><br/><b>Validation:</b><br/>‚Ä¢ Ki·ªÉm tra r·ªóng khi validating<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói: ""Tr·∫°ng th√°i ki·ªÉm kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng""<br/><br/><color=Gray>L∆∞u √Ω:</color> Tr·∫°ng th√°i ki·ªÉm kho s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o database khi l∆∞u phi·∫øu ki·ªÉm kho."
                );
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho c√°c SearchLookUpEdit controls
        /// </summary>
        private void SetupSearchLookupEditSuperTips()
        {
            // SuperTip cho Kho ki·ªÉm
            if (WarehouseNameSearchLookupEdit != null)
            {
                SuperToolTipHelper.SetBaseEditSuperTip(
                    WarehouseNameSearchLookupEdit,
                    title: @"<b><color=DarkBlue>üè¢ Kho ki·ªÉm</color></b>",
                    content: @"Ch·ªçn kho ki·ªÉm t·ª´ danh s√°ch chi nh√°nh (Company Branch) ƒëang ho·∫°t ƒë·ªông.<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ Ch·ªçn kho c·∫ßn ki·ªÉm<br/>‚Ä¢ Hi·ªÉn th·ªã th√¥ng tin kho d·∫°ng HTML (m√£, t√™n)<br/>‚Ä¢ T·ª± ƒë·ªông c·∫≠p nh·∫≠t WarehouseId, CompanyBranchId v√†o DTO<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <b><color=Red>B·∫Øt bu·ªôc ch·ªçn</color></b> (c√≥ d·∫•u * ƒë·ªè)<br/>‚Ä¢ Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng<br/>‚Ä¢ Ch·ªâ hi·ªÉn th·ªã c√°c chi nh√°nh ƒëang ho·∫°t ƒë·ªông (IsActive = true)<br/><br/><b>Data Source:</b><br/>‚Ä¢ Load t·ª´ CompanyBranchBll.GetAll()<br/>‚Ä¢ Filter ch·ªâ l·∫•y c√°c chi nh√°nh ƒëang ho·∫°t ƒë·ªông<br/>‚Ä¢ S·∫Øp x·∫øp theo t√™n chi nh√°nh<br/><br/><b>Validation:</b><br/>‚Ä¢ Ki·ªÉm tra r·ªóng khi validating<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói: ""Kho ki·ªÉm kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng""<br/>‚Ä¢ Hi·ªÉn th·ªã l·ªói qua ErrorProvider n·∫øu kh√¥ng h·ª£p l·ªá<br/><br/><color=Gray>L∆∞u √Ω:</color> Kho ki·ªÉm s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o database khi l∆∞u phi·∫øu ki·ªÉm kho."
                );
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho c√°c MemoEdit controls
        /// </summary>
        private void SetupMemoEditSuperTips()
        {
            // SuperTip cho Ghi ch√∫
            if (NotesTextEdit != null)
            {
                SuperToolTipHelper.SetBaseEditSuperTip(
                    NotesTextEdit,
                    title: @"<b><color=DarkBlue>üìù Ghi ch√∫</color></b>",
                    content: @"Nh·∫≠p ghi ch√∫ ho·∫∑c m√¥ t·∫£ b·ªï sung cho phi·∫øu ki·ªÉm kho.<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ L∆∞u th√¥ng tin b·ªï sung v·ªÅ phi·∫øu ki·ªÉm kho<br/>‚Ä¢ Ghi ch√∫ v·ªÅ l√Ω do ki·ªÉm kho, ƒëi·ªÅu ki·ªán ki·ªÉm, v.v.<br/>‚Ä¢ H·ªó tr·ª£ nhi·ªÅu d√≤ng vƒÉn b·∫£n<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <color=Green>Kh√¥ng b·∫Øt bu·ªôc</color> (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)<br/>‚Ä¢ Kh√¥ng gi·ªõi h·∫°n ƒë·ªô d√†i<br/><br/><color=Gray>L∆∞u √Ω:</color> Ghi ch√∫ s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o database khi l∆∞u phi·∫øu ki·ªÉm kho."
                );
            }

            // SuperTip cho L√Ω do
            if (ReasonTextEdit != null)
            {
                SuperToolTipHelper.SetBaseEditSuperTip(
                    ReasonTextEdit,
                    title: @"<b><color=DarkBlue>üìã L√Ω do</color></b>",
                    content: @"Nh·∫≠p l√Ω do ki·ªÉm kho.<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ Ghi nh·∫≠n l√Ω do th·ª±c hi·ªán ki·ªÉm kho<br/>‚Ä¢ H·ªó tr·ª£ tra c·ª©u v√† theo d√µi<br/>‚Ä¢ H·ªó tr·ª£ nhi·ªÅu d√≤ng vƒÉn b·∫£n<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <color=Green>Kh√¥ng b·∫Øt bu·ªôc</color> (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)<br/>‚Ä¢ Kh√¥ng gi·ªõi h·∫°n ƒë·ªô d√†i<br/><br/><color=Gray>L∆∞u √Ω:</color> L√Ω do s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o database khi l∆∞u phi·∫øu ki·ªÉm kho."
                );
            }
        }

        /// <summary>
        /// Thi·∫øt l·∫≠p SuperToolTip cho c√°c ToggleSwitch controls
        /// </summary>
        private void SetupToggleSwitchSuperTips()
        {
            // SuperTip cho Kh√≥a phi·∫øu
            if (IsLockedToggleSwitch != null)
            {
                SuperToolTipHelper.SetBaseEditSuperTip(
                    IsLockedToggleSwitch,
                    title: @"<b><color=DarkBlue>üîí Kh√≥a phi·∫øu</color></b>",
                    content: @"B·∫≠t/t·∫Øt kh√≥a phi·∫øu ki·ªÉm kho.<br/><br/><b>Ch·ª©c nƒÉng:</b><br/>‚Ä¢ Kh√≥a phi·∫øu ƒë·ªÉ kh√¥ng cho ch·ªânh s·ª≠a<br/>‚Ä¢ B·∫£o v·ªá d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n<br/>‚Ä¢ Ghi nh·∫≠n th·ªùi gian v√† ng∆∞·ªùi kh√≥a<br/><br/><b>Tr·∫°ng th√°i:</b><br/>‚Ä¢ <color=Blue>Ch∆∞a kh√≥a</color>: C√≥ th·ªÉ ch·ªânh s·ª≠a<br/>‚Ä¢ <color=Red>ƒê√£ kh√≥a</color>: Kh√¥ng th·ªÉ ch·ªânh s·ª≠a<br/><br/><b>R√†ng bu·ªôc:</b><br/>‚Ä¢ <color=Green>Kh√¥ng b·∫Øt bu·ªôc</color> (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)<br/>‚Ä¢ M·∫∑c ƒë·ªãnh: Ch∆∞a kh√≥a<br/><br/><color=Gray>L∆∞u √Ω:</color> Khi kh√≥a phi·∫øu, h·ªá th·ªëng s·∫Ω ghi nh·∫≠n th·ªùi gian v√† ng∆∞·ªùi kh√≥a."
                );
            }
        }

        #endregion

        #region ========== HELPER METHODS ==========

        /// <summary>
        /// Hi·ªÉn th·ªã l·ªói t·ª´ Exception
        /// </summary>
        private void ShowError(Exception ex, string message)
        {
            try
            {
                // T√¨m parent form ƒë·ªÉ l√†m owner cho MsgBox
                var parentForm = FindForm();
                
                // S·ª≠ d·ª•ng MsgBox.ShowException ho·∫∑c ShowError v·ªõi th√¥ng b√°o chi ti·∫øt
                if (ex != null)
                {
                    MsgBox.ShowException(ex, message, parentForm);
                }
                else
                {
                    MsgBox.ShowError(message, "L·ªói", parentForm);
                }
            }
            catch
            {
                // Fallback n·∫øu c√≥ l·ªói khi hi·ªÉn th·ªã MsgBox
                System.Diagnostics.Debug.WriteLine($"L·ªói: {message}: {ex?.Message}");
            }
        }

        /// <summary>
        /// Hi·ªÉn th·ªã l·ªói
        /// </summary>
        private void ShowError(string message)
        {
            try
            {
                // T√¨m parent form ƒë·ªÉ l√†m owner cho MsgBox
                var parentForm = FindForm();
                
                // S·ª≠ d·ª•ng MsgBox.ShowError
                MsgBox.ShowError(message, "L·ªói", parentForm);
            }
            catch
            {
                // Fallback n·∫øu c√≥ l·ªói khi hi·ªÉn th·ªã MsgBox
                System.Diagnostics.Debug.WriteLine($"L·ªói: {message}");
            }
        }

        #endregion
    }
}